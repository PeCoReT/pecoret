<script>
import { MarkdownEditor } from '@/components/editor';
import BaseLayout from '@/layout/base/BaseLayout.vue';
import { Tabs } from '@/components/tabs';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import DefaultSkeleton from '@/components/skeleton/DefaultSkeleton.vue';
import ContainerLayout from '@/layouts/ContainerLayout.vue';

export default {
    name: 'TranslationUpdate',
    components: { ContainerLayout, DefaultSkeleton, Tabs, BaseLayout, MarkdownEditor, Input, Button },
    mounted() {
        this.dataLoaded = false;
        this.getItem();
    },
    data() {
        return {
            templateId: this.$route.params.templateId,
            model: {},
            dataLoaded: false,
            loading: false,
            language: this.$route.params.language,
            breadcrumbs: [
                {
                    label: 'Vulnerability Templates',
                    to: this.$router.resolve({
                        name: 'VulnerabilityTemplateList'
                    })
                },
                {
                    label: 'Update',
                    disabled: true
                }
            ],
            translationMenuItems: [
                {
                    label: 'EN',
                    route: this.$router.resolve({
                        name: 'VulnerabilityTemplateUpdate',
                        params: {
                            templateId: this.$route.params.templateId
                        }
                    }).href
                }
            ]
        };
    },
    methods: {
        patchTranslation() {
            let data = {
                name: this.model.name,
                description: this.model.description,
                recommendation: this.model.recommendation,
                remediation: this.model.remediation
            };
            this.$api
                .patch(
                    this.$api.e.vulnTemplateTranslationDetail,
                    {
                        vulnPk: this.templateId,
                        pk: this.language
                    },
                    data
                )
                .then(() => {
                    this.$toaster({
                        title: 'Vulnerability template updated!',
                        duration: 3000,
                        description: 'Vulnerability template was updated successfully!'
                    });
                });
        },
        deleteTranslation() {
            this.$confirm.require({
                message: 'Do you want to delete this translation?',
                header: 'Delete Confirmation',
                icon: 'fa fa-trash',
                acceptClass: 'p-button-danger',
                accept: () => {
                    this.$api
                        .delete(this.$api.e.vulnTemplateTranslationDetail, {
                            vulnPk: this.templateId,
                            pk: this.language
                        })
                        .then(() => {
                            this.$router.push({
                                name: 'VulnerabilityTemplateUpdate',
                                params: {
                                    templateId: this.templateId
                                }
                            });
                        });
                }
            });
        },
        getItem() {
            this.$api
                .get(this.$api.e.vulnTemplateDetail, { pk: this.templateId })
                .then((response) => {
                    if (response.data.translations && response.data.translations.length > 0) {
                        response.data.translations.forEach((item) => {
                            if (item.language !== 'en') {
                                this.translationMenuItems.push({
                                    label: item.language.toUpperCase(),
                                    route: this.$router.resolve({
                                        name: 'VulnerabilityTemplateTranslationUpdate',
                                        params: {
                                            templateId: this.templateId,
                                            language: item.language
                                        }
                                    }).href
                                });
                            }
                        });
                    }
                    this.$api
                        .get(this.$api.e.vulnTemplateTranslationDetail, {
                            vulnPk: this.templateId,
                            pk: this.language
                        })
                        .then((response) => {
                            this.model = response.data;
                        });
                })
                .finally(() => {
                    this.dataLoaded = true;
                });
        }
    }
};
</script>

<template>
    <ContainerLayout>
        <template #right-header>
            <Button variant="destructive" @click="deleteTranslation"><i class="fa fa-trash" /> Delete</Button>
        </template>
        <template #left-header>
            <Tabs v-if="dataLoaded === true" :items="translationMenuItems" class="md:max-w-md"></Tabs>
        </template>
        <div v-if="dataLoaded === true && language !== 'en'">
            <Form class="mt-3">
                <Field label="Name">
                    <Input id="name" v-model="model.name"></Input>
                </Field>
                <Field label="Description">
                    <MarkdownEditor v-model="model.description"></MarkdownEditor>
                </Field>
                <Field label="Recommendation">
                    <MarkdownEditor v-model="model.recommendation"></MarkdownEditor>
                </Field>
                <Field label="Remediation">
                    <Input v-model="model.remediation"></Input>
                </Field>
                <Button class="w-full" @click="patchTranslation">Save</Button>
            </Form>
        </div>
        <div v-else>
            <DefaultSkeleton></DefaultSkeleton>
        </div>
    </ContainerLayout>
</template>
