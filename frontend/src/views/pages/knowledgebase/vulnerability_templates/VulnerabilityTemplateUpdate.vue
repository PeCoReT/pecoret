<script>
import { MarkdownEditor } from '@/components/editor';
import { SeveritySelectField } from '@/partials/common';
import BaseLayout from '@/layout/base/BaseLayout.vue';
import { Tabs } from '@/components/tabs';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import ModelCombobox from '@/components/combobox/ModelCombobox.vue';
import DefaultSkeleton from '@/components/skeleton/DefaultSkeleton.vue';
import ContainerLayout from '@/layouts/ContainerLayout.vue';

export default {
    name: 'VulnerabilityTemplateUpdate',
    components: {
        ContainerLayout,
        DefaultSkeleton,
        ModelCombobox,
        Button,
        Tabs,
        BaseLayout,
        MarkdownEditor,
        SeveritySelectField,
        Input
    },
    mounted() {
        this.dataLoaded = false;
        this.getItem();
    },
    data() {
        return {
            templateId: this.$route.params.templateId,
            model: {},
            dataLoaded: false,
            loading: false,
            language: 'en',
            translationMenuItems: [
                {
                    label: 'EN',
                    route: this.$router.resolve({
                        name: 'VulnerabilityTemplateUpdate',
                        params: {
                            templateId: this.$route.params.templateId
                        }
                    }).href
                }
            ]
        };
    },
    methods: {
        patchVulnerability() {
            let data = {
                name: this.model.name,
                vulnerability_id: this.model.vulnerability_id,
                severity: this.model.severity,
                description: this.model.description,
                recommendation: this.model.recommendation,
                remediation: this.model.remediation,
                cwe: this.model.cwe
            };
            this.$api.patch(this.$api.e.vulnTemplateDetail, { pk: this.templateId }, data).then(() => {
                this.$toaster({
                    title: 'Vulnerability template updated!',
                    duration: 3000,
                    description: 'Vulnerability template was updated successfully!'
                });
            });
        },
        confirmDialogDelete() {
            this.$confirm.require({
                message: 'Do you want to delete this template?',
                header: 'Delete Confirmation',
                icon: 'fa fa-trash',
                acceptClass: 'p-button-danger',
                accept: () => {
                    this.$api.delete(this.$api.e.vulnTemplateDetail, { pk: this.templateId }).then(() => {
                        this.$router.push({
                            name: 'VulnerabilityTemplateList'
                        });
                    });
                }
            });
        },
        getItem() {
            this.$api
                .get(this.$api.e.vulnTemplateDetail, { pk: this.templateId })
                .then((response) => {
                    this.model = response.data;
                    if (this.model.translations && this.model.translations.length > 0) {
                        this.model.translations.forEach((item) => {
                            if (item.language !== 'en') {
                                this.translationMenuItems.push({
                                    label: item.language.toUpperCase(),
                                    route: this.$router.resolve({
                                        name: 'VulnerabilityTemplateTranslationUpdate',
                                        params: {
                                            templateId: this.templateId,
                                            language: item.language
                                        }
                                    }).href
                                });
                            }
                        });
                    }
                })
                .finally(() => {
                    this.dataLoaded = true;
                });
        }
    }
};
</script>

<template>
    <ContainerLayout>
        <template #left-header>
            <div class="md:max-w-md">
                <Tabs v-if="dataLoaded === true" :items="translationMenuItems"></Tabs>
            </div>
        </template>
        <template #right-header>
            <div class="gap-2 flex">
                <Button :href="this.$router.resolve({ name: 'TranslationCreate', params: { templateId: this.templateId } }).href" as="a"><i class="fa fa-plus" /> Translation </Button>
                <Button variant="destructive" @click="confirmDialogDelete"><i class="fa fa-trash" /> Delete</Button>
            </div>
        </template>
        <template #pre-content-left>
            <div class="flex justify-start"></div>
        </template>
        <template #pre-content-right>
            <div class="flex justify-end gap-2">
                <Button :href="this.$router.resolve({ name: 'TranslationCreate', params: { templateId: this.templateId } }).href" as="a" variant="outline"><i class="fa fa-plus" /> Translation </Button>
                <Button variant="destructive" @click="confirmDialogDelete"><i class="fa fa-trash" /> Delete</Button>
            </div>
        </template>
        <div v-if="dataLoaded === true && language === 'en'" class="col-span-12">
            <Form class="mt-3">
                <Field label="Name">
                    <Input id="name" v-model="model.name"></Input>
                </Field>
                <Field label="Vulnerability ID">
                    <Input id="vulnerability_id" v-model="model.vulnerability_id"></Input>
                </Field>
                <Field label="Severity">
                    <SeveritySelectField v-model="model.severity"></SeveritySelectField>
                </Field>
                <Field label="Description">
                    <MarkdownEditor v-model="model.description"></MarkdownEditor>
                </Field>
                <Field label="Recommendation">
                    <MarkdownEditor v-model="model.recommendation"></MarkdownEditor>
                </Field>
                <Field label="Remediation">
                    <Input v-model="model.remediation"></Input>
                </Field>
                <Field label="CWE-ID">
                    <ModelCombobox v-model="model.cwe" :api-endpoint="this.$api.e.cweList" label="Select CWE">
                        <template #trigger="{ label }">
                            <Button class="justify-between text-muted-foreground" role="combobox" variant="outline">
                                {{ model.cwe ? label : 'Select CWE' }}
                                <i class="ml-2 h-4 w-4 shrink-0 opacity-50 fa fa-chevron-down" />
                            </Button>
                        </template>
                    </ModelCombobox>
                </Field>

                <Button class="w-full" @click="patchVulnerability"> Save</Button>
            </Form>
        </div>
        <Card v-else>
            <DefaultSkeleton></DefaultSkeleton>
        </Card>
    </ContainerLayout>
</template>
