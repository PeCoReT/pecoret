<script>
import { MarkdownEditor } from '@/components/editor';
import { SeveritySelectField } from '@/partials/common';
import BaseLayout from '@/layout/base/BaseLayout.vue';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/select';
import { severityChoices } from '@/utils/constants';
import ModelCombobox from '@/components/combobox/ModelCombobox.vue';
import { Button } from '@/components/ui/button';

export default {
    name: 'VulnerabilityTemplateCreate',
    components: { Button, ModelCombobox, Select, BaseLayout, MarkdownEditor, SeveritySelectField, Input },
    data() {
        return {
            model: {},
            dataLoaded: false,
            cweDataLoaded: false,
            cweChoices: null,
            loading: false,
            breadcrumbs: [
                {
                    label: 'Vulnerability Templates',
                    route: this.$router.resolve({
                        name: 'VulnerabilityTemplateList'
                    })
                },
                {
                    label: 'Create',
                    disabled: true
                }
            ]
        };
    },
    methods: {
        severityChoices() {
            return severityChoices;
        },
        createVulnerability() {
            let data = {
                name: this.model.name,
                vulnerability_id: this.model.vulnerability_id,
                severity: this.model.severity,
                description: this.model.description,
                recommendation: this.model.recommendation,
                remediation: this.model.remediation,
                cwe: this.model.cwe
            };
            this.$api.post(this.$api.e.vulnTemplateList, null, data).then((response) => {
                this.$toaster({
                    title: 'Vulnerability template created!',
                    duration: 3000,
                    description: 'Vulnerability template was created successfully!'
                });
                this.$router.push({
                    name: 'VulnerabilityTemplateUpdate',
                    params: {
                        templateId: response.data.pk
                    }
                });
            });
        }
    }
};
</script>

<template>
    <BaseLayout :breadcrumbs="breadcrumbs">
        <div class="col-span-12">
            <div class="card">
                <Form>
                    <Field label="Name">
                        <Input id="name" v-model="model.name"></Input>
                    </Field>
                    <Field label="Vulnerability ID">
                        <Input id="vulnerability_id" v-model="model.vulnerability_id"></Input>
                    </Field>
                    <Field label="Severity">
                        <Select v-model="model.severity" :options="severityChoices()"></Select>
                    </Field>
                    <Field label="Description">
                        <MarkdownEditor v-model="model.description"></MarkdownEditor>
                    </Field>
                    <Field label="Recommendation">
                        <MarkdownEditor v-model="model.recommendation"></MarkdownEditor>
                    </Field>
                    <Field label="Remediation">
                        <Input v-model="model.remediation"></Input>
                    </Field>
                    <Field label="CWE-ID">
                        <ModelCombobox v-model="model.cwe" :api-endpoint="this.$api.e.cweList" label="Select CWE">
                            <template #trigger="{ label }">
                                <Button class="justify-between text-muted-foreground" role="combobox" variant="outline">
                                    {{ model.cwe ? label : 'Select CWE' }}
                                    <i class="ml-2 h-4 w-4 shrink-0 opacity-50 fa fa-chevron-down" />
                                </Button>
                            </template>
                        </ModelCombobox>
                    </Field>
                    <Button :loading="loading" class="w-full" label="Save" @click="createVulnerability"></Button>
                </Form>
            </div>
        </div>
    </BaseLayout>
</template>
