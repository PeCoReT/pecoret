<script>
import { SeveritySelectField } from '@/partials/common';
import { MarkdownEditor } from '@/components/editor';
import { Breadcrumb } from '@/components/breadcrumb';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import ModelCombobox from '@/components/combobox/ModelCombobox.vue';
import { Select } from '@/components/select';
import { severityChoices } from '@/utils/constants';
import DefaultSkeleton from '@/components/skeleton/DefaultSkeleton.vue';
import ContainerLayout from '@/layouts/ContainerLayout.vue';

export default {
    name: 'VulnerabilityPage',
    data() {
        return {
            loading: false,
            model: {
                name: null,
                vulnerability_id: null,
                title: null,
                description: '',
                recommendation: '',
                cwe: null,
                remediation: null
            },
            dataLoaded: false,
            cweDataLoaded: false,
            projectId: this.$route.params.projectId,
            vulnerabilityId: this.$route.params.vulnerabilityId,
            cweChoices: null
        };
    },
    mounted() {
        this.getVulnerability();
    },
    methods: {
        severityChoices() {
            return severityChoices;
        },
        getVulnerability() {
            this.$api
                .get(this.$api.e.pVulnDetail, {
                    projectPk: this.projectId,
                    pk: this.vulnerabilityId
                })
                .then((response) => {
                    this.model = response.data;
                    if (response.data.cwe !== null) {
                        this.$api.get(this.$api.e.cweDetail, { pk: response.data.cwe.pk }).then((response2) => {
                            this.cweChoices = [response2.data];
                            this.model.cwe = response.data.cwe.pk;
                            this.cweDataLoaded = true;
                        });
                    } else {
                        this.cweDataLoaded = true;
                        this.cweChoices = [];
                    }

                    this.dataLoaded = true;
                });
        },
        patchVulnerability() {
            this.loading = true;
            let data = {
                name: this.model.name,
                vulnerability_id: this.model.vulnerability_id,
                description: this.model.description,
                recommendation: this.model.recommendation,
                severity: this.model.severity,
                cwe: this.model.cwe,
                remediation: this.model.remediation
            };
            this.$api
                .patch(this.$api.e.pVulnDetail, { projectPk: this.projectId, pk: this.vulnerabilityId }, data)
                .then(() => {
                    this.$toaster({
                        title: 'Vulnerability Updated!',
                        description: 'Vulnerability was updated successfully!',
                        duration: 3000
                    });
                })
                .finally(() => {
                    this.loading = false;
                });
        }
    },
    components: {
        ContainerLayout,
        DefaultSkeleton,
        Select,
        ModelCombobox,
        SeveritySelectField,
        MarkdownEditor,
        Breadcrumb,
        Button,
        Input
    }
};
</script>

<template>
    <ContainerLayout>

        <h3 class="text-3xl mb-3">Update Vulnerability</h3>
        <Form v-if="dataLoaded">
            <Field label="Name">
                <Input id="name" v-model="model.name"></Input>
            </Field>
            <Field label="Vulnerability ID">
                <Input id="vulnerability_id" v-model="model.vulnerability_id"></Input>
            </Field>
            <Field label="Severity">
                <Select v-model="model.severity" :options="severityChoices()"></Select>
            </Field>
            <Field label="Description">
                <MarkdownEditor v-model="model.description"></MarkdownEditor>
            </Field>
            <Field label="Recommendation">
                <MarkdownEditor v-model="model.recommendation"></MarkdownEditor>
            </Field>
            <Field label="CWE-ID">
                <ModelCombobox v-model="model.cwe" :api-endpoint="this.$api.e.cweList" label="Select CWE">
                    <template #trigger="{ label }">
                        <Button class="justify-between text-muted-foreground" role="combobox" variant="outline">
                            {{ model.cwe ? label : 'Select CWE' }}
                            <i class="ml-2 h-4 w-4 shrink-0 opacity-50 fa fa-chevron-down" />
                        </Button>
                    </template>
                </ModelCombobox>
            </Field>
            <Button class="w-full" @click="patchVulnerability">Save</Button>
        </Form>
        <div v-else>
            <DefaultSkeleton></DefaultSkeleton>
        </div>
    </ContainerLayout>
</template>
