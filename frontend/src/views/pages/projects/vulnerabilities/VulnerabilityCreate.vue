<script>
import { SeveritySelectField } from '@/partials/common';
import { MarkdownEditor } from '@/components/editor';
import { Card } from '@/components/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import ModelCombobox from '@/components/combobox/ModelCombobox.vue';
import { Select } from '@/components/select';
import { severityChoices } from '@/utils/constants';
import ContainerLayout from "@/layouts/ContainerLayout.vue";

export default {
    name: 'VulnerabilityCreate',
    data() {
        return {
            loading: false,
            model: {
                name: null,
                vulnerability_id: null,
                severity: null,
                remediation: null,
                description: '',
                recommendation: '',
                cwe: null
            },
            cweChoices: null,
            projectId: this.$route.params.projectId,
            template: null,
            breadcrumbs: [
                {
                    label: 'Vulnerabilities',
                    route: this.$router.resolve({
                        name: 'VulnerabilityList',
                        params: {
                            projectId: this.$route.params.projectId
                        }
                    })
                },
                {
                    label: 'Create',
                    disabled: true
                }
            ]
        };
    },
    methods: {
        severityChoices() {
            return severityChoices;
        },
        onTemplateChange(template) {
            this.model.severity = template.severity;
            this.model.name = template.name;
            this.model.description = template.description;
            this.model.recommendation = template.recommendation;
            this.model.remediation = template.remediation;
            this.cweChoices = [template.cwe];
            if (template.cwe) {
                this.model.cwe = template.cwe;
            } else {
                this.model.cwe = null;
            }
        },
        createVulnerability() {
            this.loading = true;
            if (this.model.cwe && this.model.cwe.pk) {
                this.model.cwe = this.model.cwe.pk;
            }
            this.$api
                .post(this.$api.e.pVulnList, { projectPk: this.projectId }, this.model)
                .then(() => {
                    this.$toaster({
                        title: 'Vulnerability Created!',
                        description: 'Vulnerability was created successfully!',
                        duration: 3000
                    });
                    this.$router.push({
                        name: 'VulnerabilityList',
                        params: {
                            projectId: this.projectId
                        }
                    });
                })
                .finally(() => {
                    this.loading = false;
                });
        }
    },
    components: {
        ContainerLayout,
        Select,
        ModelCombobox,
        SeveritySelectField,
        MarkdownEditor,
        Card,
        Input,
        Button
    }
};
</script>
<template>
    <ContainerLayout>
        <h3 class="text-3xl mb-3 col-span-12">Create Vulnerability</h3>
        <div class="col-span-12">
            <Form>
                <Field label="Vulnerability Template">
                    <ModelCombobox v-model="template" :api-endpoint="this.$api.e.pVulnerabilitySearch" :url-args="{ pPk: this.projectId }" label="Vulnerability Template" @select="onTemplateChange">
                        <template #trigger="{ label }">
                            <Button class="justify-between" role="combobox" variant="outline">
                                {{ template ? label : 'Select a template...' }}
                                <i class="ml-2 h-4 w-4 shrink-0 opacity-50 fa fa-chevron-down" />
                            </Button>
                        </template>
                    </ModelCombobox>
                </Field>
                <Field label="Name">
                    <Input id="name" v-model="model.name"></Input>
                </Field>
                <Field label="Vulnerability ID">
                    <Input id="vulnerability_id" v-model="model.vulnerability_id"></Input>
                </Field>
                <Field label="Severity">
                    <Select v-model="model.severity" :options="severityChoices()"></Select>
                </Field>
                <Field label="Remediation">
                    <Input v-model="model.remediation"></Input>
                </Field>
                <Field label="Description">
                    <MarkdownEditor v-model="model.description"></MarkdownEditor>
                </Field>
                <Field label="Recommendation">
                    <MarkdownEditor v-model="model.recommendation"></MarkdownEditor>
                </Field>
                <Field label="CWE-ID">
                    <ModelCombobox v-model="model.cwe" :api-endpoint="this.$api.e.cweList" label="Select CWE">
                        <template #trigger="{ label }">
                            <Button class="justify-between text-muted-foreground" role="combobox" variant="outline">
                                {{ model.cwe ? label : 'Select CWE' }}
                                <i class="ml-2 h-4 w-4 shrink-0 opacity-50 fa fa-chevron-down" />
                            </Button>
                        </template>
                    </ModelCombobox>
                </Field>
                <Button class="w-full" @click="createVulnerability">Save</Button>
            </Form>
        </div>
    </ContainerLayout>
</template>
